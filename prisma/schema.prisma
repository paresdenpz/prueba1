generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Store {
  id                                   Int                   @id @default(autoincrement())
  name                                 String
  address                              String?
  phone                                String?
  logoUrl                              String?
  ticketFooter                         String?
  status                               String                @default("ACTIVE")
  maxShiftHours                        Int                   @default(18)
  defaultMinStock                      Int                   @default(5)
  alertEmail                           String?
  ticketHeader                         String?
  CashMovement                         CashMovement[]
  CashRegisterShift                    CashRegisterShift[]
  CustomerCredit                       CustomerCredit[]
  Inventory                            Inventory[]
  InventoryAdjustment                  InventoryAdjustment[]
  Layaway                              Layaway[]
  Order                                Order[]
  Purchase                             Purchase[]
  Return                               Return[]
  Sale                                 Sale[]
  SupplierReturn                       SupplierReturn[]
  Transfer_Transfer_fromStoreIdToStore Transfer[]            @relation("Transfer_fromStoreIdToStore")
  Transfer_Transfer_toStoreIdToStore   Transfer[]            @relation("Transfer_toStoreIdToStore")
  User                                 User[]
  Warranty                             Warranty[]

  @@map("Store")
}

model Announcement {
  id          Int       @id @default(autoincrement())
  title       String
  message     String
  type        String    @default("INFO")
  priority    String    @default("NORMAL")
  targetType  String    @default("ALL")
  storeIds    Int[]
  isActive    Boolean   @default(true)
  startDate   DateTime  @default(now())
  endDate     DateTime?
  createdById Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  User        User      @relation(fields: [createdById], references: [id])
}

model AuditLog {
  id          String   @id
  userId      Int?
  action      String
  module      String
  description String?
  ipAddress   String?
  userAgent   String?
  metadata    Json?
  createdAt   DateTime @default(now())
  User        User?    @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([createdAt])
  @@index([userId])
}

model CashMovement {
  id                Int               @id @default(autoincrement())
  shiftId           Int
  userId            Int
  storeId           Int
  type              String
  concept           String
  amount            Float
  notes             String?
  createdAt         DateTime          @default(now())
  categoryId        Int?
  ExpenseCategory   ExpenseCategory?  @relation(fields: [categoryId], references: [id])
  CashRegisterShift CashRegisterShift @relation(fields: [shiftId], references: [id])
  Store             Store             @relation(fields: [storeId], references: [id])
  User              User              @relation(fields: [userId], references: [id])
}

model CashRegisterShift {
  id                                      Int              @id @default(autoincrement())
  storeId                                 Int
  openedById                              Int
  closedById                              Int?
  startDate                               DateTime         @default(now())
  endDate                                 DateTime?
  initialAmount                           Float
  finalAmount                             Float?
  status                                  String           @default("OPEN")
  notes                                   String?
  createdAt                               DateTime         @default(now())
  updatedAt                               DateTime
  CashMovement                            CashMovement[]
  User_CashRegisterShift_closedByIdToUser User?            @relation("CashRegisterShift_closedByIdToUser", fields: [closedById], references: [id])
  User_CashRegisterShift_openedByIdToUser User             @relation("CashRegisterShift_openedByIdToUser", fields: [openedById], references: [id])
  Store                                   Store            @relation(fields: [storeId], references: [id])
  CreditPayment                           CreditPayment[]
  LayawayPayment                          LayawayPayment[]
  Return                                  Return[]
  Sale                                    Sale[]
}

model Category {
  id                       Int                        @id @default(autoincrement())
  name                     String
  parentId                 Int?
  commissionPercentage     Float                      @default(0)
  Category                 Category?                  @relation("CategoryToCategory", fields: [parentId], references: [id])
  other_Category           Category[]                 @relation("CategoryToCategory")
  CustomerCategoryDiscount CustomerCategoryDiscount[]
  OrderItem                OrderItem[]
  Product                  Product[]
}

model CreditPayment {
  id                Int                @id @default(autoincrement())
  customerCreditId  Int
  amount            Float
  paymentMethod     String
  shiftId           Int?
  userId            Int
  createdAt         DateTime           @default(now())
  reference         String?
  CustomerCredit    CustomerCredit     @relation(fields: [customerCreditId], references: [id])
  CashRegisterShift CashRegisterShift? @relation(fields: [shiftId], references: [id])
  User              User               @relation(fields: [userId], references: [id])
}

model Customer {
  id                       Int                        @id @default(autoincrement())
  name                     String
  rfc                      String?                    @unique
  email                    String?
  phone                    String?
  address                  String?
  birthDate                DateTime?
  status                   String                     @default("ACTIVE")
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  discountPercentage       Float                      @default(0)
  points                   Int                        @default(0)
  priceTier                String                     @default("PUBLIC")
  notes                    String?
  CustomerCategoryDiscount CustomerCategoryDiscount[]
  CustomerCredit           CustomerCredit[]
  Layaway                  Layaway[]
  Sale                     Sale[]
}

model CustomerCategoryDiscount {
  id         Int      @id @default(autoincrement())
  customerId Int
  categoryId Int
  percentage Float
  Category   Category @relation(fields: [categoryId], references: [id])
  Customer   Customer @relation(fields: [customerId], references: [id])

  @@unique([customerId, categoryId])
}

model CustomerCredit {
  id            Int             @id @default(autoincrement())
  customerId    Int
  storeId       Int
  saleId        Int?            @unique
  totalAmount   Float
  paidAmount    Float           @default(0)
  status        String          @default("OPEN")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  CreditPayment CreditPayment[]
  Customer      Customer        @relation(fields: [customerId], references: [id])
  Sale          Sale?           @relation(fields: [saleId], references: [id])
  Store         Store           @relation(fields: [storeId], references: [id])
}

model ExpenseCategory {
  id           Int            @id @default(autoincrement())
  name         String         @unique
  description  String?
  type         String         @default("EXPENSE")
  createdAt    DateTime       @default(now())
  CashMovement CashMovement[]
}

model Inventory {
  id        Int      @id @default(autoincrement())
  productId Int
  storeId   Int
  quantity  Int      @default(0)
  serials   String[]
  minStock  Int      @default(5)
  Product   Product  @relation(fields: [productId], references: [id])
  Store     Store    @relation(fields: [storeId], references: [id])

  @@unique([productId, storeId])
}

model InventoryAdjustment {
  id        Int      @id @default(autoincrement())
  storeId   Int
  productId Int
  quantity  Int
  reason    String
  notes     String?
  userId    Int
  createdAt DateTime @default(now())
  Product   Product  @relation(fields: [productId], references: [id])
  Store     Store    @relation(fields: [storeId], references: [id])
  User      User     @relation(fields: [userId], references: [id])
}

model Layaway {
  id             Int              @id @default(autoincrement())
  storeId        Int
  customerId     Int
  userId         Int
  totalAmount    Float
  paidAmount     Float            @default(0)
  status         String           @default("PENDING")
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime
  expirationDate DateTime?
  Customer       Customer         @relation(fields: [customerId], references: [id])
  Store          Store            @relation(fields: [storeId], references: [id])
  User           User             @relation(fields: [userId], references: [id])
  LayawayItem    LayawayItem[]
  LayawayPayment LayawayPayment[]
}

model LayawayItem {
  id        Int      @id @default(autoincrement())
  layawayId Int
  productId Int
  quantity  Int
  price     Float
  serials   String[]
  total     Float
  Layaway   Layaway  @relation(fields: [layawayId], references: [id])
  Product   Product  @relation(fields: [productId], references: [id])
}

model LayawayPayment {
  id                Int                @id @default(autoincrement())
  layawayId         Int
  amount            Float
  paymentMethod     String
  reference         String?
  shiftId           Int?
  userId            Int
  createdAt         DateTime           @default(now())
  Layaway           Layaway            @relation(fields: [layawayId], references: [id])
  CashRegisterShift CashRegisterShift? @relation(fields: [shiftId], references: [id])
  User              User               @relation(fields: [userId], references: [id])
}

model Order {
  id               Int         @id @default(autoincrement())
  supplierId       Int
  storeId          Int
  userId           Int
  orderNumber      String      @unique
  status           String      @default("PENDING")
  totalAmount      Float
  notes            String?
  expectedDelivery DateTime?
  receivedAt       DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime
  Store            Store       @relation(fields: [storeId], references: [id])
  Supplier         Supplier    @relation(fields: [supplierId], references: [id])
  User             User        @relation(fields: [userId], references: [id])
  OrderItem        OrderItem[]
}

model OrderItem {
  id               Int       @id @default(autoincrement())
  orderId          Int
  productId        Int?
  quantity         Int
  expectedCost     Float     @default(0)
  receivedQuantity Int       @default(0)
  total            Float
  customName       String?
  notes            String?
  categoryId       Int?
  Category         Category? @relation(fields: [categoryId], references: [id])
  Order            Order     @relation(fields: [orderId], references: [id])
  Product          Product?  @relation(fields: [productId], references: [id])
}

model Product {
  id                   Int                   @id @default(autoincrement())
  name                 String
  sku                  String                @unique
  barcode              String?               @unique
  description          String?
  cost                 Float                 @default(0)
  price                Float                 @default(0)
  wholesale            Float                 @default(0)
  categoryId           Int?
  type                 String                @default("STANDARD")
  status               String                @default("ACTIVE")
  commissionPercentage Float                 @default(0)
  createdAt            DateTime              @default(now())
  Inventory            Inventory[]
  InventoryAdjustment  InventoryAdjustment[]
  LayawayItem          LayawayItem[]
  OrderItem            OrderItem[]
  Category             Category?             @relation(fields: [categoryId], references: [id])
  ProductRegionPrice   ProductRegionPrice[]
  PurchaseItem         PurchaseItem[]
  ReturnItem           ReturnItem[]
  SaleItem             SaleItem[]
  SupplierReturnItem   SupplierReturnItem[]
  TransferItem         TransferItem[]
  Warranty             Warranty[]
}

model ProductRegionPrice {
  id         Int     @id @default(autoincrement())
  productId  Int
  regionId   Int
  price      Float
  percentage Float?
  Product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  Region     Region  @relation(fields: [regionId], references: [id], onDelete: Cascade)

  @@unique([productId, regionId])
}

model Promotion {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  type            String
  startDate       DateTime
  endDate         DateTime?
  isActive        Boolean   @default(true)
  triggerType     String
  triggerId       Int?
  minQuantity     Int       @default(1)
  targetType      String
  targetId        Int?
  rewardQuantity  Int       @default(1)
  discountPercent Float?
  discountAmount  Float?
  storeIds        Int[]
  createdById     Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  User            User      @relation(fields: [createdById], references: [id])
}

model Purchase {
  id             Int              @id @default(autoincrement())
  supplierId     Int
  storeId        Int
  userId         Int
  invoiceRef     String?
  total          Float
  createdAt      DateTime         @default(now())
  Store          Store            @relation(fields: [storeId], references: [id])
  Supplier       Supplier         @relation(fields: [supplierId], references: [id])
  User           User             @relation(fields: [userId], references: [id])
  PurchaseItem   PurchaseItem[]
  SupplierReturn SupplierReturn[]
}

model PurchaseItem {
  id         Int      @id @default(autoincrement())
  purchaseId Int
  productId  Int
  quantity   Int
  cost       Float
  serials    String[]
  total      Float
  Product    Product  @relation(fields: [productId], references: [id])
  Purchase   Purchase @relation(fields: [purchaseId], references: [id])
}

model Region {
  id                 Int                  @id @default(autoincrement())
  name               String               @unique
  code               String               @unique
  description        String?
  active             Boolean              @default(true)
  createdAt          DateTime             @default(now())
  ProductRegionPrice ProductRegionPrice[]
}

model Return {
  id                Int                @id @default(autoincrement())
  originalSaleId    Int
  storeId           Int
  userId            Int
  shiftId           Int?
  totalRefund       Float
  reason            String?
  notes             String?
  paymentMethod     String             @default("CASH")
  createdAt         DateTime           @default(now())
  Sale              Sale               @relation(fields: [originalSaleId], references: [id])
  CashRegisterShift CashRegisterShift? @relation(fields: [shiftId], references: [id])
  Store             Store              @relation(fields: [storeId], references: [id])
  User              User               @relation(fields: [userId], references: [id])
  ReturnItem        ReturnItem[]
}

model ReturnItem {
  id        Int      @id @default(autoincrement())
  returnId  Int
  productId Int
  quantity  Int
  unitPrice Float
  total     Float
  serials   String[]
  Product   Product  @relation(fields: [productId], references: [id])
  Return    Return   @relation(fields: [returnId], references: [id])
}

model Sale {
  id                Int                @id @default(autoincrement())
  storeId           Int
  userId            Int
  customerId        Int?
  shiftId           Int?
  total             Float
  paymentMethod     String             @default("CASH")
  payments          String?
  financingDetails  String?
  financingStatus   String             @default("NA")
  financingPaidAt   DateTime?
  createdAt         DateTime           @default(now())
  CustomerCredit    CustomerCredit?
  Return            Return[]
  Customer          Customer?          @relation(fields: [customerId], references: [id])
  CashRegisterShift CashRegisterShift? @relation(fields: [shiftId], references: [id])
  Store             Store              @relation(fields: [storeId], references: [id])
  User              User               @relation(fields: [userId], references: [id])
  SaleItem          SaleItem[]
  Warranty          Warranty[]
}

model SaleItem {
  id               Int      @id @default(autoincrement())
  saleId           Int
  productId        Int
  quantity         Int
  price            Float
  serials          String[]
  total            Float
  commissionAmount Float    @default(0)
  promotionName    String?
  returnedQuantity Int      @default(0)
  cost             Float    @default(0)
  Product          Product  @relation(fields: [productId], references: [id])
  Sale             Sale     @relation(fields: [saleId], references: [id])
}

model Supplier {
  id             Int              @id @default(autoincrement())
  name           String
  contact        String?
  phone          String?
  email          String?
  Order          Order[]
  Purchase       Purchase[]
  SupplierReturn SupplierReturn[]
}

model SupplierReturn {
  id                 Int                  @id @default(autoincrement())
  supplierId         Int
  storeId            Int
  userId             Int
  purchaseId         Int?
  totalAmount        Float
  notes              String?
  status             String               @default("COMPLETED")
  createdAt          DateTime             @default(now())
  Purchase           Purchase?            @relation(fields: [purchaseId], references: [id])
  Store              Store                @relation(fields: [storeId], references: [id])
  Supplier           Supplier             @relation(fields: [supplierId], references: [id])
  User               User                 @relation(fields: [userId], references: [id])
  SupplierReturnItem SupplierReturnItem[]
}

model SupplierReturnItem {
  id               Int            @id @default(autoincrement())
  supplierReturnId Int
  productId        Int
  quantity         Int
  cost             Float
  serials          String[]
  total            Float
  Product          Product        @relation(fields: [productId], references: [id])
  SupplierReturn   SupplierReturn @relation(fields: [supplierReturnId], references: [id])
}

model Transfer {
  id                                Int            @id @default(autoincrement())
  fromStoreId                       Int
  toStoreId                         Int
  status                            String         @default("PENDING")
  createdById                       Int?
  receivedById                      Int?
  receivedAt                        DateTime?
  createdAt                         DateTime       @default(now())
  updatedAt                         DateTime
  User_Transfer_createdByIdToUser   User?          @relation("Transfer_createdByIdToUser", fields: [createdById], references: [id])
  Store_Transfer_fromStoreIdToStore Store          @relation("Transfer_fromStoreIdToStore", fields: [fromStoreId], references: [id])
  User_Transfer_receivedByIdToUser  User?          @relation("Transfer_receivedByIdToUser", fields: [receivedById], references: [id])
  Store_Transfer_toStoreIdToStore   Store          @relation("Transfer_toStoreIdToStore", fields: [toStoreId], references: [id])
  TransferItem                      TransferItem[]
}

model TransferItem {
  id         Int      @id @default(autoincrement())
  transferId Int
  productId  Int
  quantity   Int
  serials    String[]
  Product    Product  @relation(fields: [productId], references: [id])
  Transfer   Transfer @relation(fields: [transferId], references: [id])
}

model User {
  id                                                   Int                   @id @default(autoincrement())
  username                                             String                @unique
  password                                             String
  role                                                 String                @default("SELLER")
  name                                                 String?
  storeId                                              Int?
  monthlySalesTarget                                   Float                 @default(0)
  createdAt                                            DateTime              @default(now())
  updatedAt                                            DateTime
  isActive                                             Boolean               @default(true)
  Announcement                                         Announcement[]
  AuditLog                                             AuditLog[]
  CashMovement                                         CashMovement[]
  CashRegisterShift_CashRegisterShift_closedByIdToUser CashRegisterShift[]   @relation("CashRegisterShift_closedByIdToUser")
  CashRegisterShift_CashRegisterShift_openedByIdToUser CashRegisterShift[]   @relation("CashRegisterShift_openedByIdToUser")
  CreditPayment                                        CreditPayment[]
  InventoryAdjustment                                  InventoryAdjustment[]
  Layaway                                              Layaway[]
  LayawayPayment                                       LayawayPayment[]
  Order                                                Order[]
  Promotion                                            Promotion[]
  Purchase                                             Purchase[]
  Return                                               Return[]
  Sale                                                 Sale[]
  SupplierReturn                                       SupplierReturn[]
  Transfer_Transfer_createdByIdToUser                  Transfer[]            @relation("Transfer_createdByIdToUser")
  Transfer_Transfer_receivedByIdToUser                 Transfer[]            @relation("Transfer_receivedByIdToUser")
  Store                                                Store?                @relation(fields: [storeId], references: [id])
  UserSession                                          UserSession[]
  Warranty                                             Warranty[]
}

model UserSession {
  id           String   @id
  userId       Int
  token        String   @unique
  deviceName   String?
  deviceType   String?
  ipAddress    String?
  location     String?
  userAgent    String?
  isActive     Boolean  @default(true)
  lastActivity DateTime @default(now())
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([token])
  @@index([userId])
}

model Warranty {
  id              Int      @id @default(autoincrement())
  saleId          Int
  productId       Int
  storeId         Int
  serial          String?
  status          String   @default("RECEIVED")
  technicianNotes String?
  brandTicket     String?
  customerNotes   String?
  userId          Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  Product         Product  @relation(fields: [productId], references: [id])
  Sale            Sale     @relation(fields: [saleId], references: [id])
  Store           Store    @relation(fields: [storeId], references: [id])
  User            User     @relation(fields: [userId], references: [id])
}
